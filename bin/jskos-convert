#!/usr/bin/env node

const fs = require("fs")
const request = require("request")
const program = require("../lib/cli")
const convert = require("../lib/jskos-convert")
const { guessObjectType } = require("jskos-tools")

program
  .usage("[options] [type] file...")
  .option("-f, --from <format>","input format (ndjson or csv)")
  .option("-t, --to <format>","output format (ndjson or csv)")
  .option("-l, --language <lang>", "include labels (use '-' for any language)")
  .example("mappings -t csv mappings.ndjson")
  .example("concepts http://example.org/jskos.ndjson")

program
  .action( () => {
    const env = program
    const args = env.args || []

    if (args.length > 1) {
      args.pop()
    } else {
      program.help()
    }

    let type = (guessObjectType(args[0]) || "").toLowerCase().replace(/^concept(.+)/, "$1")
    if (type) {
      args.shift()
    } else {
      type = "concept"
    }

    const to = env.to || "ndjson"
    const { language } = env
    const output = process.stdout
    
    output.on("error", err => {
      if (err.code == "EPIPE") {
        process.exit(0)
      }
    })

    while (args.length > 0) {
      let file = args.shift()
      let input = process.stdin
      let from = env.from

      if (file.match(/https?:\/\//)) {
        //const proto = require(file.match(/^https/) ? 'https' : 'http')
        input = request.get(file)
      } else if (file !== "-") {
        let ext = file.match(/\.(csv|ndjson)$/)
        if (!from && ext) {
          from = ext[1]
        }
        input = fs.createReadStream(file)
      }

      from = from || "ndjson"
      input.on("error", e => { console.error(`${file}: ${e.message}`) })
      convert({ from, to, type, language, input, output })
    }
  })

program.parse(process.argv)
